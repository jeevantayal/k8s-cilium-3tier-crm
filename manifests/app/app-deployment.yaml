apiVersion: apps/v1
kind: Deployment
metadata:
  name: crm-app
  namespace: crm-app
  labels:
    app: crm-app
    tier: application
spec:
  replicas: 3
  selector:
    matchLabels:
      app: crm-app
      tier: application
  template:
    metadata:
      labels:
        app: crm-app
        tier: application
    spec:
      containers:
      - name: crm-app
        image: python:3.11-slim
        command: ["/bin/sh"]
        args:
        - -c
        - |
          pip install flask psycopg2-binary gunicorn -q
          cat > /app/app.py << 'EOF'
          from flask import Flask, jsonify, request
          import psycopg2
          import os
          import socket
          
          app = Flask(__name__)
          
          def get_db_connection():
              db_host = os.getenv('DB_HOST', 'postgres-service.crm-app.svc.cluster.local')
              db_name = os.getenv('DB_NAME', 'crmdb')
              db_user = os.getenv('DB_USER', 'crmuser')
              db_password = os.getenv('DB_PASSWORD', 'crmpass123')
              return psycopg2.connect(
                  host=db_host,
                  database=db_name,
                  user=db_user,
                  password=db_password
              )
          
          @app.route('/health', methods=['GET'])
          def health():
              return jsonify({
                  'status': 'healthy',
                  'pod': socket.gethostname()
              }), 200
          
          @app.route('/api/customers', methods=['GET'])
          def get_customers():
              try:
                  conn = get_db_connection()
                  cur = conn.cursor()
                  cur.execute('SELECT id, name, email FROM customers ORDER BY id;')
                  customers = cur.fetchall()
                  cur.close()
                  conn.close()
                  return jsonify({
                      'customers': [{'id': c[0], 'name': c[1], 'email': c[2]} for c in customers],
                      'pod': socket.gethostname()
                  }), 200
              except Exception as e:
                  return jsonify({'error': str(e), 'pod': socket.gethostname()}), 500
          
          @app.route('/api/customers', methods=['POST'])
          def create_customer():
              try:
                  data = request.get_json()
                  conn = get_db_connection()
                  cur = conn.cursor()
                  cur.execute(
                      'INSERT INTO customers (name, email) VALUES (%s, %s) RETURNING id;',
                      (data.get('name'), data.get('email'))
                  )
                  customer_id = cur.fetchone()[0]
                  conn.commit()
                  cur.close()
                  conn.close()
                  return jsonify({
                      'id': customer_id,
                      'name': data.get('name'),
                      'email': data.get('email'),
                      'pod': socket.gethostname()
                  }), 201
              except Exception as e:
                  return jsonify({'error': str(e), 'pod': socket.gethostname()}), 500
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=5000)
          EOF
          gunicorn -w 1 -b 0.0.0.0:5000 --timeout 120 app:app
        env:
        - name: DB_HOST
          value: "postgres-service.crm-app.svc.cluster.local"
        - name: DB_NAME
          value: "crmdb"
        - name: DB_USER
          value: "crmuser"
        - name: DB_PASSWORD
          value: "crmpass123"
        ports:
        - containerPort: 5000
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

